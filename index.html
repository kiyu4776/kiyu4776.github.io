<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZIPファイルダウンロード</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }
        #loading {
            display: none;
            font-size: 18px;
            color: #555;
        }
        #download {
            display: none;
            margin-top: 20px;
        }
        #footer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            color: gray;
            font-size: 14px;
        }
        #error, #fileError {
            color: red;
            display: none;
        }
        #preview {
            margin-top: 10px;
            max-width: 300px;
            display: none;
        }
    </style>
</head>
<body>

    <h2>IDを入力してください</h2>
    <input type="text" id="userId" placeholder="AB123456"><br><br>

    <h3>画像を選択（PNGのみ）</h3>
    <input type="file" id="imageUpload" accept=".png"><br>
    <p id="fileError">PNGファイルを選択してください</p>
    <img id="preview" alt="画像プレビュー"><br><br>

    <button onclick="validate()">確認</button>

    <p id="error">IDの形式が正しくありません</p>
    <p id="loading">ロード中... しばらくお待ちください</p>

    <div id="download">
        <a id="downloadLink" download="randomized.zip">ZIPをダウンロード</a>
    </div>

    <div id="footer">@kiyu47764</div>

    <script>
        function validate() {
            const userId = document.getElementById("userId").value;
            const regex = /^[A-Za-z]{2}\d{6}$/; // 英字2文字 + 数字6文字
            const errorMsg = document.getElementById("error");
            const fileInput = document.getElementById("imageUpload");
            const fileError = document.getElementById("fileError");
            const loading = document.getElementById("loading");
            const download = document.getElementById("download");
            const downloadLink = document.getElementById("downloadLink");

            let valid = true;

            // IDチェック
            if (!regex.test(userId)) {
                errorMsg.style.display = "block";
                valid = false;
            } else {
                errorMsg.style.display = "none";
            }

            // PNG画像チェック
            if (!fileInput.files.length || !fileInput.files[0].name.toLowerCase().endsWith(".png")) {
                fileError.style.display = "block";
                valid = false;
            } else {
                fileError.style.display = "none";
            }

            if (!valid) return;

            // ロード開始
            loading.style.display = "block";
            download.style.display = "none";

            const waitTime = Math.floor(Math.random() * 6) + 5; // 5〜10秒待機
            setTimeout(() => {
                createZip(userId, fileInput.files[0]);
            }, waitTime * 1000);
        }

        // IDを元に乱数化
        function createZip(userId, imageFile) {
            let seed = 0;
            for (let i = 0; i < userId.length; i++) {
                seed += userId.charCodeAt(i) * (i + 1);
            }

            function random(seed) {
                let x = Math.sin(seed) * 10000;
                return x - Math.floor(x);
            }

            let randomText = "";
            for (let i = 0; i < 100; i++) {
                randomText += String.fromCharCode(65 + Math.floor(random(seed + i) * 26));
            }

            const zip = new JSZip();
            zip.file("random.txt", randomText);

            // 画像をZIPに追加
            const reader = new FileReader();
            reader.onload = function(e) {
                zip.file("image.png", e.target.result.split(',')[1], { base64: true });

                zip.generateAsync({ type: "blob" }).then(function (blob) {
                    const url = URL.createObjectURL(blob);
                    document.getElementById("downloadLink").href = url;
                    document.getElementById("loading").style.display = "none";
                    document.getElementById("download").style.display = "block";
                });
            };
            reader.readAsDataURL(imageFile);
        }

        // 画像プレビュー
        document.getElementById("imageUpload").addEventListener("change", function(event) {
            const file = event.target.files[0];
            const preview = document.getElementById("preview");
            const fileError = document.getElementById("fileError");

            if (file && file.type === "image/png") {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = "block";
                };
                reader.readAsDataURL(file);
                fileError.style.display = "none";
            } else {
                preview.style.display = "none";
                fileError.style.display = "block";
            }
        });
    </script>

</body>
</html>
